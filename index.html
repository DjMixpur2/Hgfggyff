<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UlluSeriesHub - Video App</title>
    <!-- Google Font Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(to right, #000000, #1F2940);
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
        }
        button, .telegram-join-btn, .menu-icon { cursor: pointer; font-family: inherit; }

        /* --- Views --- */
        .view { display: none; }
        .view.active { display: block; }

        /* --- Header --- */
        .app-header { background-color: #0F1A2E; box-shadow: 0 2px 5px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000; }
        .header-content-wrapper { max-width: 1000px; margin: 0 auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .menu-icon { font-size: 1.8em; color: #ffffff; padding: 5px 10px 5px 0; margin-right: 10px; line-height: 1; user-select: none; }
        
        /* === MODERN TITLE STYLE (Updated Color) === */
        .header-title-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4em;
            font-weight: 700;
            flex-grow: 1;
            letter-spacing: -1px;
            /* Premium Gold & Orange Gradient */
            background: linear-gradient(90deg, #F97316, #FBBF24);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .telegram-join-btn { background-color: #0088cc; color: white; padding: 7px 14px; border-radius: 20px; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease-in-out; white-space: nowrap; border: none; }
        .telegram-join-btn:hover { background-color: #0077b3; }

        /* --- Category Sidebar --- */
        .category-sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background-color: #0c1524; box-shadow: 2px 0 8px rgba(0,0,0,0.5); padding: 20px; transition: left 0.3s ease-in-out; z-index: 1002; overflow-y: auto; }
        .category-sidebar.active { left: 0; }
        .category-sidebar-title { font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0; border-bottom: 1px solid #1F2940; padding-bottom: 10px; }
        .category-list { list-style: none; }
        .category-list-item { padding: 10px 5px; color: #cccccc; cursor: pointer; border-radius: 4px; transition: background-color 0.2s, color 0.2s; font-size: 1em; }
        .category-list-item:hover { background-color: #1F2940; color: #ffffff; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: none; transition: opacity 0.3s ease-in-out; opacity: 0; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- Search Bar --- */
        .search-bar-container { padding: 10px 20px; background-color: #0F1A2E; position: sticky; z-index: 999; }
        .search-input-wrapper { position: relative; max-width: 760px; margin: 0 auto; }
        #searchVideosInput { width: 100%; padding: 10px 18px; font-size: 1em; border-radius: 25px; border: 1px solid #2a3b58; background-color: #182237; color: #e0e0e0; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #searchVideosInput::placeholder { color: #778899; }
        #searchVideosInput:focus { border-color: #3F51B5; box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3); }
        
        /* --- Video List --- */
        .video-grid-container { max-width: 800px; margin: 20px auto; padding: 0 10px; }
        .video-item { background-color: #1e1e1e; border-radius: 6px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor: pointer; }
        .video-thumbnail-container { position: relative; width: 100%; padding-bottom: 56.25%; background-color: #333; }
        .video-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .video-duration-overlay { position: absolute; background-color: rgba(0,0,0,0.7); color: white; padding: 3px 7px; border-radius: 3px; font-size: 0.75em; font-weight: 500; top: 8px; left: 8px; }
        .video-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 10px 8px 10px; background: linear-gradient(to top, rgba(0,0,0,0.85) 65%, transparent); }
        .video-title { font-size: 1.1em; font-weight: 600; color: #ffffff; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; padding: 15px 0; margin-top: 15px; }
        .pagination-controls button { background-color: #3F51B5; color: white; border: none; padding: 8px 12px; margin: 0 5px; border-radius: 4px; font-size: 0.85em; transition: background-color 0.2s; }
        .pagination-controls button:disabled { background-color: #444; color: #888; cursor: not-allowed; }
        .pagination-info { font-size: 0.9em; color: #ccc; margin: 0 10px; }
        
        /* --- Loaders --- */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3F51B5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .video-grid-container .loader { margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #fullScreenLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0c1524; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }

        /* --- Player View --- */
        #playerViewContainer { padding: 10px; max-width: 1000px; margin: 0 auto; }
        #playerVideoTitle { font-size: 1.3em; margin-bottom: 10px; word-break: break-word; }
        #videoPlayerWrapper { position: relative; width: 100%; background-color: #000; aspect-ratio: 16 / 9; }
        
        #mainVideoPlayer, #iframePlayerContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        #iframePlayerContainer iframe { width: 100%; height: 100%; border: none; }
        
        /* --- NEW: Player Action Buttons --- */
        .player-controls-bar {
            display: flex;
            align-items: center;
            gap: 15px; /* Buttons ke beech ka space */
            margin-top: 15px;
            margin-bottom: 20px;
        }
        #backToListBtn {
            background-color: #3F51B5;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 0; /* Margin ab container handle karega */
        }
        #downloadVideoBtn {
            background-color: #28a745; /* Green color for download */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            text-decoration: none; /* <a> tag se underline hatane ke liye */
            font-weight: 500;
            transition: background-color 0.2s;
        }
        #downloadVideoBtn:hover {
            background-color: #218838;
        }

        /* --- Related Videos --- */
        #relatedVideosContainer { margin-top: 20px; border-top: 1px solid #2a3b58; padding-top: 15px; }
        .related-videos-title { font-size: 1.1em; font-weight: 500; color: #e0e0e0; margin-bottom: 12px; }
        .related-video-item { display: flex; align-items: flex-start; margin-bottom: 12px; cursor: pointer; }
        .related-video-thumbnail { width: 120px; min-width: 120px; height: 67px; object-fit: cover; border-radius: 4px; margin-right: 12px; background-color: #333; }
        .related-video-info { flex-grow: 1; overflow: hidden; }
        .related-video-title { font-size: 0.9em; color: #e0e0e0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- Fullscreen Mode Styling --- */
        body.video-is-fullscreen { overflow: hidden; }
        body.video-is-fullscreen .app-header,
        body.video-is-fullscreen #playerVideoTitle,
        body.video-is-fullscreen .player-controls-bar, /* NEW: Hide controls in fullscreen */
        body.video-is-fullscreen #relatedVideosContainer { display: none !important; }
        body.video-is-fullscreen #playerViewContainer { padding: 0; max-width: 100%; }
        body.video-is-fullscreen #videoPlayerWrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; }

        /* --- Search Results Dropdown --- */
        #searchResultsContainer { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: #0c1524; border: 1px solid #2a3b58; border-radius: 8px; margin-top: 8px; max-height: 70vh; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        #searchResultsContainer.active { display: block; }
        .search-result-item { display: flex; align-items: flex-start; padding: 10px; cursor: pointer; border-bottom: 1px solid #1F2940; transition: background-color 0.2s; }
        .search-result-item:hover { background-color: #1F2940; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-thumbnail { width: 100px; min-width: 100px; height: 56px; object-fit: cover; border-radius: 4px; margin-right: 12px; background-color: #333; }
        .search-result-info { flex-grow: 1; overflow: hidden; }
        .search-result-title { font-size: 0.9em; color: #e0e0e0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .no-search-results { padding: 20px; text-align: center; color: #999; }
    </style>
</head>
<body>
    <div id="fullScreenLoader">
        <div class="loader"></div>
    </div>

    <div id="categorySidebar" class="category-sidebar"></div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <header class="app-header">
        <div class="header-content-wrapper">
            <span id="menuIcon" class="menu-icon">☰</span>
            <span class="header-title-text">UlluSeriesHub</span>
            <a href="https://t.me/your_channel_name" target="_blank" class="telegram-join-btn">Join Telegram</a>
        </div>
    </header>

    <div class="search-bar-container" style="display: none;">
        <div class="search-input-wrapper">
            <input type="text" id="searchVideosInput" placeholder="Search videos..." autocomplete="off">
            <div id="searchResultsContainer"></div>
        </div>
    </div>

    <div id="listView" class="view">
        <main class="video-grid-container" id="videoGrid"></main>
        <nav class="pagination-controls" id="paginationControlsEl"></nav>
    </div>

    <div id="playerView" class="view">
        <div id="playerViewContainer">
            <h2 id="playerVideoTitle"></h2>
            <div id="videoPlayerWrapper">
                <video id="mainVideoPlayer" style="display:none;" controls controlsList="nodownload" playsinline webkit-playsinline></video>
                <div id="iframePlayerContainer" style="display:none;"></div>
            </div>
            <!-- === MODIFIED: Buttons are now in a container === -->
            <div class="player-controls-bar">
                <button id="backToListBtn">← Back to List</button>
                <a id="downloadVideoBtn" href="#" style="display: none;" download>Download Video</a>
            </div>
            <div id="relatedVideosContainer"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyC5pjNgY6SR3e1YeYAdf8glM29Gpc2Whkk",
          authDomain: "tournament-4dd48.firebaseapp.com",
          databaseURL: "https://tournament-4dd48-default-rtdb.firebaseio.com",
          projectId: "tournament-4dd48",
          storageBucket: "tournament-4dd48.firebasestorage.app",
          messagingSenderId: "432883056274",
          appId: "1:432883056274:web:c23afb68be69e33f20304b"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Global Variables & Element Selectors ---
        const fullScreenLoader = document.getElementById('fullScreenLoader');
        const listView = document.getElementById('listView');
        const playerView = document.getElementById('playerView');
        const videoGrid = document.getElementById('videoGrid');
        const searchVideosInput = document.getElementById('searchVideosInput');
        const menuIcon = document.getElementById('menuIcon');
        const categorySidebar = document.getElementById('categorySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const paginationControlsEl = document.getElementById('paginationControlsEl');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const downloadVideoBtn = document.getElementById('downloadVideoBtn'); // NEW: Download button selector

        let allVideosMaster = []; 
        let allVideos = [];       
        let currentPage = 1;
        const videosPerPage = 5;
        let sampleCategories = ["All"];

        // --- Helper Functions ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Main Functions ---
        async function initializeApp() {
            try {
                await fetchCategoriesFromFirebase();
                renderCategories();
                await fetchVideosFromFirebase();
                showView(listView);
                adjustHeaderPosition();
            } catch (error) {
                console.error("Initialization failed:", error);
                videoGrid.innerHTML = "<p>Failed to load application data.</p>";
                showView(listView);
            } finally {
                fullScreenLoader.style.opacity = '0';
                setTimeout(() => { fullScreenLoader.style.display = 'none'; }, 500);
            }
        }

        function showView(viewToShow) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            if (viewToShow) viewToShow.classList.add('active');
            const isListView = viewToShow === listView;
            document.querySelector('.search-bar-container').style.display = isListView ? 'block' : 'none';
            if (isListView) {
                hideSearchResults();
            }
        }

        function adjustHeaderPosition() {
            const headerHeight = document.querySelector('.app-header').offsetHeight;
            document.querySelector('.search-bar-container').style.top = `${headerHeight}px`;
        }

        async function fetchCategoriesFromFirebase() {
            const snapshot = await database.ref('/categories').once('value');
            const categories = snapshot.val();
            if (categories) {
                sampleCategories = ["All", ...Object.keys(categories)];
            }
        }

        function renderCategories() {
            categorySidebar.innerHTML = '';
            const title = document.createElement('h3');
            title.className = 'category-sidebar-title';
            title.textContent = 'Categories';
            categorySidebar.appendChild(title);
            const ul = document.createElement('ul');
            ul.className = 'category-list';
            sampleCategories.forEach(categoryName => {
                const li = document.createElement('li');
                li.className = 'category-list-item';
                li.textContent = categoryName;
                li.addEventListener('click', () => filterByCategory(categoryName));
                ul.appendChild(li);
            });
            categorySidebar.appendChild(ul);
        }

        function filterByCategory(categoryName) {
            if (categoryName === "All") {
                allVideos = [...allVideosMaster];
            } else {
                allVideos = allVideosMaster.filter(video => video.category === categoryName);
            }
            currentPage = 1;
            searchVideosInput.value = "";
            hideSearchResults();
            displayVideosOnPage();
            toggleSidebar();
        }

        async function fetchVideosFromFirebase() {
            videoGrid.innerHTML = `<div class="loader"></div>`; 
            const snapshot = await database.ref('/videos').orderByChild('timestamp').once('value');
            videoGrid.innerHTML = '';
            const data = snapshot.val();
            if (data) { 
                allVideosMaster = Object.values(data).reverse();
                allVideos = [...allVideosMaster];
                displayVideosOnPage(); 
            } else { 
                videoGrid.innerHTML = "<p>No videos found.</p>";
            }
        }

        function displayVideosOnPage() {
            const paginatedVideos = allVideos.slice((currentPage - 1) * videosPerPage, currentPage * videosPerPage);
            videoGrid.innerHTML = '';
            if (paginatedVideos.length === 0) {
                const message = searchVideosInput.value ? "No videos match your search." : "No videos in this category.";
                videoGrid.innerHTML = `<p>${message}</p>`;
                paginationControlsEl.innerHTML = '';
                return;
            }
            paginatedVideos.forEach(video => {
                const item = document.createElement('article');
                item.className = 'video-item';
                item.innerHTML = `
                    <div class="video-thumbnail-container">
                        <img src="${video.thumbnailUrl || 'https://via.placeholder.com/640x360.png?text=No+Thumb'}" alt="${video.title}" class="video-thumbnail" loading="lazy">
                        ${video.duration ? `<div class="video-duration-overlay">${video.duration}</div>` : ''}
                        <div class="video-info"><h3 class="video-title">${video.title}</h3></div>
                    </div>`;
                item.addEventListener('click', () => openPlayerView(video));
                videoGrid.appendChild(item);
            });
            setupPagination();
        }

        function setupPagination() {
            paginationControlsEl.innerHTML = '';
            const totalPages = Math.ceil(allVideos.length / videosPerPage);
            if (totalPages <= 1) return;
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; displayVideosOnPage(); window.scrollTo(0, 0); } };
            paginationControlsEl.appendChild(prevBtn);
            const pageInfo = document.createElement('span');
            pageInfo.className = 'pagination-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            paginationControlsEl.appendChild(pageInfo);
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; displayVideosOnPage(); window.scrollTo(0, 0); } };
            paginationControlsEl.appendChild(nextBtn);
        }

        // === MODIFIED: openPlayerView function ab Download button ko handle karta hai ===
        function openPlayerView(video) {
            document.getElementById('playerVideoTitle').textContent = video.title;
            const mainPlayer = document.getElementById('mainVideoPlayer');
            const iframeContainer = document.getElementById('iframePlayerContainer');
            
            // Player aur buttons ko reset karna
            mainPlayer.style.display = 'none';
            iframeContainer.style.display = 'none';
            downloadVideoBtn.style.display = 'none'; // Pehle se hide kardo

            if (mainPlayer.src) mainPlayer.pause();
            iframeContainer.innerHTML = '';

            if (video.type === 'direct') {
                mainPlayer.style.display = 'block';
                mainPlayer.src = video.videoUrl;
                mainPlayer.play().catch(e => console.warn("Autoplay was prevented."));
                
                // Download button ko set aur show karna
                downloadVideoBtn.href = video.videoUrl;
                // Browser ke liye ek safe filename banana
                downloadVideoBtn.download = (video.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'video') + '.mp4';
                downloadVideoBtn.style.display = 'inline-block';

            } else { // YouTube, GDrive, etc. ke liye
                iframeContainer.style.display = 'block';
                let url = '';
                if (video.type === 'youtube') {
                    url = `${video.videoUrl}?autoplay=1&rel=0`;
                } else if (video.type === 'gdrive') {
                    const fileId = (video.videoUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/) || [])[1];
                    if (fileId) {
                        url = `https://drive.google.com/file/d/${fileId}/preview`;
                    }
                }
                iframeContainer.innerHTML = `<iframe src="${url}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                // Yahan download button hidden hi rahega
            }

            renderRelatedVideos(video.id);
            showView(playerView);
            window.scrollTo(0, 0);
        }
        
        function showSearchResults(term) {
            const results = allVideosMaster.filter(v => v.title.toLowerCase().includes(term));
            searchResultsContainer.innerHTML = '';

            if (results.length > 0) {
                results.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <img src="${video.thumbnailUrl || 'https://via.placeholder.com/100x56.png?text=N/A'}" alt="${video.title}" class="search-result-thumbnail" loading="lazy">
                        <div class="search-result-info">
                            <h4 class="search-result-title">${video.title}</h4>
                        </div>`;
                    item.addEventListener('click', () => openPlayerView(video));
                    searchResultsContainer.appendChild(item);
                });
            } else {
                searchResultsContainer.innerHTML = `<div class="no-search-results">No videos match your search.</div>`;
            }

            videoGrid.style.display = 'none';
            paginationControlsEl.style.display = 'none';
            searchResultsContainer.classList.add('active');
        }

        function hideSearchResults() {
            searchResultsContainer.classList.remove('active');
            videoGrid.style.display = 'block';
            paginationControlsEl.style.display = 'flex';
        }

        function renderRelatedVideos(currentVideoId) {
            const container = document.getElementById('relatedVideosContainer');
            container.innerHTML = '';
            const related = allVideosMaster.filter(v => v.id !== currentVideoId).sort(() => 0.5 - Math.random()).slice(0, 5);
            if (related.length === 0) return;

            const titleEl = document.createElement('h3');
            titleEl.className = 'related-videos-title';
            titleEl.textContent = 'Up Next';
            container.appendChild(titleEl);

            related.forEach(video => {
                const item = document.createElement('div');
                item.className = 'related-video-item';
                item.innerHTML = `
                    <img src="${video.thumbnailUrl || 'https://via.placeholder.com/120x67.png?text=N/A'}" alt="${video.title}" class="related-video-thumbnail" loading="lazy">
                    <div class="related-video-info">
                        <h4 class="related-video-title">${video.title}</h4>
                    </div>`;
                item.addEventListener('click', () => openPlayerView(video));
                container.appendChild(item);
            });
        }

        function toggleSidebar() {
            categorySidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }

        // --- Event Listeners ---
        // === MODIFIED: Back button listener ab download button ko bhi reset karta hai ===
        document.getElementById('backToListBtn').addEventListener('click', () => {
            const mainPlayer = document.getElementById('mainVideoPlayer');
            if (mainPlayer.src) mainPlayer.pause();
            document.getElementById('iframePlayerContainer').innerHTML = '';
            downloadVideoBtn.style.display = 'none'; // Wapas jaate waqt hide kardo
            showView(listView);
        });
        
        searchVideosInput.addEventListener('input', debounce((event) => {
            const term = event.target.value.toLowerCase().trim();
            if (term.length > 0) {
                showSearchResults(term);
            } else {
                hideSearchResults();
            }
        }, 300));

        document.addEventListener('click', (event) => {
            if (!searchVideosInput.contains(event.target) && !searchResultsContainer.contains(event.target)) {
                if(searchVideosInput.value.length === 0) {
                    hideSearchResults();
                }
            }
        });

        menuIcon.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        window.addEventListener('resize', adjustHeaderPosition);
        
        function handleFullscreenChange() {
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
            if (isFullscreen) {
                document.body.classList.add('video-is-fullscreen');
            } else {
                document.body.classList.remove('video-is-fullscreen');
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        
        // --- App Start ---
        window.onload = initializeApp;
    </script>
</body>
</html>
