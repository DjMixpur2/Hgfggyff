<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Battle - Admin Panel</title>
    <style>
        :root {
            --primary-color: #FF8C00; --secondary-color: #4CAF50; --background-color: #0D1117;
            --card-background: #161B22; --text-color: #E6EDF3; --text-color-muted: #8B949E;
            --border-color: #30363D; --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --danger-color: #F85149; --info-color: #58A6FF; --success-color: var(--secondary-color);
            --disabled-color: #484f58; --sidebar-bg: #1A2238; --header-bg: #161B22;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family); background-color: var(--background-color);
            color: var(--text-color); font-size: 15px; line-height: 1.6;
            display: flex; height: 100vh; overflow: hidden;
        }
        #adminLoginScreen { display: flex; align-items: center; justify-content: center; width: 100%; height: 100vh; flex-direction: column; padding: 20px; }
        #adminLoginForm { width: 100%; max-width: 400px; padding: 30px; background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; }
        #adminLoginForm h2 { text-align: center; margin-bottom: 25px; color: var(--primary-color); }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid var(--border-color); position: fixed; left: 0; top: 0; bottom: 0; z-index: 1100; transform: translateX(0); transition: transform 0.3s ease-in-out; }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid var(--border-color); text-align: center;}
        .sidebar-header h2 { font-size: 1.5em; color: var(--text-color); }
        .sidebar-header span { font-size: 0.8em; color: var(--text-color-muted); }
        .sidebar nav { flex-grow: 1; margin-top: 20px; overflow-y: auto; }
        .sidebar nav a { display: flex; align-items: center; gap: 15px; padding: 12px 20px; color: var(--text-color-muted); text-decoration: none; font-weight: 500; border-left: 3px solid transparent; transition: all 0.2s ease; }
        .sidebar nav a:hover { background-color: var(--card-background); color: var(--text-color); }
        .sidebar nav a.active { background-color: var(--card-background); color: var(--primary-color); border-left-color: var(--primary-color); font-weight: 600; }
        .sidebar nav a svg { width: 22px; height: 22px; fill: currentColor; }
        .main-content { margin-left: 260px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; width: calc(100% - 260px); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background-color: var(--header-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .header h1 { font-size: 1.6em; }
        .admin-user { display: flex; align-items: center; gap: 10px; }
        .admin-user span { font-weight: 500; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: opacity 0.2s, background-color 0.2s; white-space: nowrap; }
        .btn:hover:not(:disabled) { opacity: 0.85; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--info-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: #f1c40f; color: #161B22; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .page { display: none; padding: 25px; overflow-y: auto; height: calc(100vh - 71px); }
        .page.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .search-container { flex-grow: 1; max-width: 400px; }
        .search-container input {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border-color);
            border-radius: 6px; background-color: #21262d; color: var(--text-color); font-size: 0.95em;
        }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stat-card { background-color: var(--card-background); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px; transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border-color: var(--primary-color); }
        .stat-card-icon { flex-shrink: 0; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card-icon svg { width: 32px; height: 32px; }
        .stat-card-info { line-height: 1.2; }
        .stat-card h3 { color: var(--text-color-muted); font-size: 0.9em; margin-bottom: 8px; text-transform: uppercase; font-weight: 500; }
        .stat-card .stat-value { font-size: 2.2em; font-weight: 700; color: var(--text-color); }
        .stat-card.users .stat-card-icon { background-color: rgba(88, 166, 255, 0.15); } .stat-card.users .stat-card-icon svg { fill: var(--info-color); }
        .stat-card.tournaments .stat-card-icon { background-color: rgba(76, 175, 80, 0.15); } .stat-card.tournaments .stat-card-icon svg { fill: var(--secondary-color); }
        .stat-card.deposits .stat-card-icon { background-color: rgba(255, 140, 0, 0.15); } .stat-card.deposits .stat-card-icon svg { fill: var(--primary-color); }
        .stat-card.withdrawals .stat-card-icon { background-color: rgba(248, 81, 73, 0.15); } .stat-card.withdrawals .stat-card-icon svg { fill: var(--danger-color); }
        .table-container { overflow-x: auto; background: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); word-break: break-all; }
        th { background-color: #21262d; font-size: 0.9em; text-transform: uppercase; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #21262d; }
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        #tournamentsListContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .admin-tournament-card { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 15px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .admin-tournament-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .admin-tournament-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .admin-tournament-card .card-header h4 { font-size: 1.2em; margin: 0; color: var(--text-color); }
        .admin-tournament-card .card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em; }
        .admin-tournament-card .card-body p { margin: 0; display: flex; flex-direction: column; }
        .admin-tournament-card .card-body .label { color: var(--text-color-muted); font-size: 0.85em; margin-bottom: 2px; text-transform: uppercase; }
        .admin-tournament-card .card-body .value { color: var(--text-color); font-weight: 600; }
        .admin-tournament-card .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .admin-tournament-card .action-btns { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
        .modal { display: none; position: fixed; z-index: 1200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px 0; }
        .modal-content { background-color: var(--card-background); margin: auto; padding: 25px 30px; border: 1px solid var(--border-color); width: 95%; max-width: 900px; border-radius: 10px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .modal-header h2 { color: var(--primary-color); font-size: 1.4em; }
        .close-btn { color: #ccc; font-size: 32px; font-weight: bold; cursor: pointer; background: none; border: none;}
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: #21262d; color: var(--text-color); }
        .form-group textarea { min-height: 80px; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600; color: white; text-transform: capitalize; white-space: nowrap;}
        .status-pending { background-color: var(--primary-color); } .status-approved, .status-completed { background-color: var(--success-color); } .status-rejected { background-color: var(--danger-color); } .status-upcoming { background-color: var(--info-color); } .status-live { background-color: #e67e22; } .status-complete, .status-canceled { background-color: var(--disabled-color); }
        #appContainer, #loader { display: none; }
        .loader-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100vh; flex-direction: column; gap: 15px;}
        .loading-spinner { border: 4px solid #555; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--info-color); color: white; padding: 12px 20px; border-radius: 8px; z-index: 2000; display: none; box-shadow: 0 3px 10px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; }
        .menu-toggle svg { width: 28px; height: 28px; fill: var(--text-color); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1099; }
        .player-list { display: flex; flex-direction: column; gap: 15px; }
        .player-card { background-color: #21262d; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; }
        .player-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 5px; }
        .player-card-header h5 { margin: 0; font-size: 1.1em; color: var(--text-color); }
        .player-card-header .player-ign { font-size: 0.9em; color: var(--text-color-muted); font-style: italic; }
        .player-details-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.9em; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 4px 0;}
        .detail-item .label { color: var(--text-color-muted); flex-shrink: 0; }
        .detail-item .value { color: var(--text-color); font-weight: 500; word-break: break-all; text-align: right; }
        .player-actions { display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .player-actions .result-group { display: flex; align-items: center; gap: 8px; }
        .player-actions .result-group label { font-size: 0.9em; color: var(--text-color-muted); }
        .player-actions input[type="number"] { max-width: 75px; padding: 6px 8px; font-size: 0.95em; }
        .player-actions .btn { padding: 6px 14px; }
        #usersListContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .admin-user-card { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 12px; transition: opacity 0.3s ease, border-color 0.3s ease; }
        .admin-user-card.banned { opacity: 0.6; border-left: 4px solid var(--danger-color); }
        .admin-user-card-header { display: flex; align-items: center; gap: 15px; }
        .admin-user-card-header .avatar { width: 45px; height: 45px; border-radius: 50%; background-color: var(--sidebar-bg); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2em; color: var(--primary-color); }
        .admin-user-card-header .user-info { display: flex; flex-direction: column; overflow: hidden; }
        .admin-user-card-header .user-info h5 { margin: 0; font-size: 1.1em; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-user-card-header .user-info .user-email { font-size: 0.85em; color: var(--text-color-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-user-card-body { display: flex; flex-direction: column; gap: 8px; padding: 12px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .admin-user-card-footer { margin-top: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; padding-top: 12px;}
        
        .content-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .content-card { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .content-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .content-card .card-image { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; background-color: #21262d; border-bottom: 1px solid var(--border-color); }
        .content-card .card-image-link { display: block; }
        .content-card .card-content { padding: 15px; flex-grow: 1; }
        .content-card h4 { font-size: 1.2em; color: var(--text-color); margin: 0; }
        .content-card .label { color: var(--text-color-muted); font-size: 0.8em; margin-bottom: 2px; text-transform: uppercase; }
        .content-card .value { color: var(--text-color); font-weight: 500; font-size: 0.9em; word-break: break-all; }
        .content-card .card-footer { padding: 15px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .content-card .card-footer .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .request-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .request-card { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; }
        .request-card.status-pending { border-left: 4px solid var(--primary-color); }
        .request-card.status-approved, .request-card.status-completed { border-left-color: var(--success-color); }
        .request-card.status-rejected { border-left-color: var(--danger-color); }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 15px; }
        .request-card-user { display: flex; flex-direction: column; overflow: hidden;}
        .request-card-user h5 { margin: 0; font-size: 1.1em; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .request-card-user .email { font-size: 0.85em; color: var(--text-color-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .request-card-amount { font-size: 1.6em; font-weight: 700; flex-shrink: 0; }
        .request-card-amount.deposit { color: var(--success-color); }
        .request-card-amount.withdrawal { color: var(--danger-color); }
        .request-card-body { display: flex; flex-direction: column; gap: 8px; font-size: 0.9em; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;}
        .request-card-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: auto; }
        .request-card-footer p { margin:0; font-size: 0.9em; color: var(--text-color-muted); align-self: center; flex-grow: 1;}

        .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-btn { background-color: var(--card-background); color: var(--text-color-muted); border: 1px solid var(--border-color); }
        .filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 600; }

        @media (min-width: 600px) { .player-details-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { #appContainer { flex-direction: column; } .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.2); } .main-content { width: 100%; margin-left: 0; } .menu-toggle { display: block; } .header h1 { font-size: 1.2em; } .page { padding: 15px; height: calc(100vh - 66px); } .form-grid { grid-template-columns: 1fr; } .modal-content { padding: 20px 15px; max-width: 95%;} .action-btns { flex-wrap: wrap; } .dashboard-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; } .stat-card { padding: 15px; gap: 12px; } .stat-card-icon { width: 45px; height: 45px; } .stat-card-icon svg { width: 22px; height: 22px; } .stat-card h3 { font-size: 0.75em; margin-bottom: 4px; } .stat-card .stat-value { font-size: 1.6em; } 
        #tournamentsListContainer, #usersListContainer, .request-card-grid, .content-card-grid { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-container"><div class="loading-spinner"></div><p id="loader-text"></p></div>
    <div id="adminLoginScreen"><form id="adminLoginForm"><h2>Admin Panel Login</h2><div class="form-group"><label for="adminEmail">Email</label><input type="email" id="adminEmail" required></div><div class="form-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" required></div><button type="submit" class="btn btn-primary" style="width:100%; padding: 12px;">Login</button></form></div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div id="appContainer" style="width:100%; height:100vh;">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2>Game Battle</h2><span>Admin Panel</span></div>
            <nav id="adminNav">
                <a href="#" class="nav-link active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"></path></svg>Dashboard</a>
                <a href="#" class="nav-link" data-page="games"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.58 16.09l-1.09-7.66C20.21 6.46 18.52 5 16.53 5H7.47C5.48 5 3.79 6.46 3.51 8.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19h0c.68 0 1.32-.27 1.76-.75L9 15h6l2.29 3.25c.44.48 1.08.75 1.76.75h0c1.55 0 2.74-1.37 2.53-2.91zM11 11H9v2H7v-2H5v-2h2V7h2v2h2v2zm7-2h-4v2h4v-2z"></path></svg>Games</a>
                <a href="#" class="nav-link" data-page="tournaments"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h4l3 3 3-3h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V6h10v2z"></path></svg>Tournaments</a>
                <a href="#" class="nav-link" data-page="promoBanners"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2 4v16h20V4H2zm18 14H4V6h16v12zM6 10h5v4H6v-4zm7 0h5v2h-5v-2zm0 4h5v2h-5v-2z"></path></svg>Promo Banners</a>
                <a href="#" class="nav-link" data-page="appContent"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>App Content</a>
                <a href="#" class="nav-link" data-page="users"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>Users</a>
                <a href="#" class="nav-link" data-page="deposits"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8l4-4 4 4h-3v4H11z"></path></svg>Deposit Requests</a>
                <a href="#" class="nav-link" data-page="withdrawals"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15v-4h3l-4 4-4-4h3v-4h2v4z"></path></svg>Withdrawal Requests</a>
                <a href="#" class="nav-link" data-page="settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>App Settings</a>
            </nav>
            <div style="padding: 20px; border-top: 1px solid var(--border-color); margin-top: auto;">
                <button class="btn btn-danger" id="adminLogoutBtn" style="width: 100%;">Logout</button>
            </div>
        </div>
        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" id="menuToggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
                <h1 id="pageTitle">Dashboard</h1>
                <div class="admin-user"><span id="adminEmailDisplay"></span></div>
            </header>
            <div class="page active" id="dashboard"></div>
            <div class="page" id="games"></div>
            <div class="page" id="tournaments"></div>
            <div class="page" id="promoBanners"></div>
            <div class="page" id="appContent"></div>
            <div class="page" id="users"></div>
            <div class="page" id="deposits"></div>
            <div class="page" id="withdrawals"></div>
            <div class="page" id="settings"></div>
        </main>
    </div>
    <div id="gameModal" class="modal"><div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2 id="gameModalTitle">Add New Game</h2><button class="close-btn">×</button></div><form id="gameForm"><input type="hidden" id="gameId"><div class="form-group full-width"><label for="gameName">Game Name</label><input type="text" id="gameName" required></div><div class="form-group full-width"><label for="gameImgUrl">Image URL</label><input type="url" id="gameImgUrl" required></div><button type="submit" class="btn btn-primary" style="width: 100%;">Save Game</button></form></div></div>
    <div id="tournamentModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tournamentModalTitle">Create Tournament</h2><button class="close-btn">×</button></div><form id="tournamentForm"><input type="hidden" id="tournamentId"><div class="form-grid"><div class="form-group"><label for="tName">Name</label><input type="text" id="tName" required></div><div class="form-group"><label for="tGameType">Game Type</label><select id="tGameType" required></select></div><div class="form-group"><label for="tDateTime">Date & Time</label><input type="datetime-local" id="tDateTime" required></div><div class="form-group"><label for="tMode">Mode (e.g., Solo, Duo)</label><input type="text" id="tMode" required></div><div class="form-group"><label for="tMap">Map (e.g., Bermuda)</label><input type="text" id="tMap" required></div><div class="form-group"><label for="tStatus">Status</label><select id="tStatus" required><option value="Upcoming">Upcoming</option><option value="Live">Live</option><option value="Complete">Complete</option><option value="Canceled">Canceled</option></select></div><div class="form-group"><label for="tEntryFee">Entry Fee</label><input type="number" id="tEntryFee" min="0" step="1" required></div><div class="form-group"><label for="tPrizePool">Total Prize Pool</label><input type="number" id="tPrizePool" min="0" required></div><div class="form-group"><label for="tPrizePerKill">Prize Per Kill</label><input type="number" id="tPrizePerKill" min="0" step="0.5" required></div><div class="form-group"><label for="tMaxPlayers">Max Players</label><input type="number" id="tMaxPlayers" min="1" required></div></div><div class="form-group full-width"><label for="tRules">Rules</label><textarea id="tRules"></textarea></div><button type="submit" class="btn btn-primary" style="width:100%;">Save Tournament</button></form></div></div>
    <div id="promoBannerModal" class="modal"><div class="modal-content" style="max-width: 550px;"><div class="modal-header"><h2 id="promoBannerModalTitle">Add New Banner</h2><button class="close-btn">×</button></div><form id="promoBannerForm"><input type="hidden" id="promoBannerId"><input type="hidden" id="promoBannerOldImageUrl"><div class="form-group full-width"><label for="promoBannerImageUrl">Image URL</label><input type="url" id="promoBannerImageUrl" placeholder="Upload an image or paste URL here" required><label for="promoBannerFileUpload" style="margin-top: 10px; cursor:pointer;" class="btn btn-secondary">Upload New Banner Image</label><input type="file" id="promoBannerFileUpload" accept="image/*" style="display:none;"><span id="promoBannerUploadProgress" style="margin-left: 10px; font-size: 0.9em;"></span></div><div class="form-group full-width"><label for="promoBannerTargetUrl">Target URL (Link on click)</label><input type="url" id="promoBannerTargetUrl" placeholder="https://example.com/offer"></div><button type="submit" class="btn btn-primary" style="width: 100%;">Save Banner</button></form></div></div>
    <div id="manageTournamentModal" class="modal"></div>
    <div id="userWalletModal" class="modal"><div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2 id="userWalletTitle">Adjust Wallet</h2><button class="close-btn">×</button></div><p>Current Balance: <strong id="currentUserBalance">₹0.00</strong></p><form id="walletAdjustmentForm" style="margin-top:15px;"><input type="hidden" id="walletUserId"><div class="form-group"><label for="adjustmentType">Type</label><select id="adjustmentType" required><option value="credit">Credit (Add)</option><option value="debit">Debit (Remove)</option></select></div><div class="form-group"><label for="adjustmentAmount">Amount (₹)</label><input type="number" id="adjustmentAmount" min="0.01" step="0.01" required></div><div class="form-group"><label for="adjustmentReason">Reason</label><input type="text" id="adjustmentReason" placeholder="e.g., Prize money for tournament X" required></div><button type="submit" class="btn btn-primary" style="width: 100%;">Update Balance</button></form></div></div>
    <div id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcOole8Om2Xvh-F9DBeg5pcjCRrWphXcE", authDomain: "tournament-1bcdd.firebaseapp.com", projectId: "tournament-1bcdd", storageBucket: "tournament-1bcdd.appspot.com", messagingSenderId: "357775256878", appId: "1:357775256878:web:569ac084ed35a35a741ebf", measurementId: "G-FWK8W68R63" };
       
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const loader = document.getElementById('loader'), loaderText = document.getElementById('loader-text'), loginScreen = document.getElementById('adminLoginScreen'), appContainer = document.getElementById('appContainer'), pageTitle = document.getElementById('pageTitle'), adminNav = document.getElementById('adminNav'), notificationDiv = document.getElementById('notification'), menuToggle = document.getElementById('menuToggle'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebarOverlay');
        let allTournamentsCache = [], allUsersCache = [], allGamesCache = [], allPromoBannersCache = [];
        auth.onAuthStateChanged(async(user) => { if (user) { loader.style.display = 'flex'; loaderText.textContent = 'Verifying admin role...'; try { const userDocRef = db.collection('users').doc(user.uid); const userDoc = await userDocRef.get(); if (userDoc.exists && userDoc.data().role === 'admin') { loader.style.display = 'none'; loginScreen.style.display = 'none'; appContainer.style.display = 'flex'; document.getElementById('adminEmailDisplay').textContent = user.email; initializeApp(); } else { if (!userDoc.exists) { await userDocRef.set({ email: user.email, username: user.email.split('@')[0], createdAt: firebase.firestore.FieldValue.serverTimestamp(), role: 'user' }); alert(`A profile has been created for you. Please ask a super-admin to set your 'role' to 'admin' in the database.`); } else { alert('Access Denied. You do not have an admin role.'); } await auth.signOut(); showLoginScreen(); } } catch (error) { console.error("Error verifying admin role: ", error); await auth.signOut(); alert('An error occurred during verification. Check the console.'); showLoginScreen(); } } else { showLoginScreen(); } });
        function showLoginScreen() { loader.style.display = 'none'; loginScreen.style.display = 'flex'; appContainer.style.display = 'none'; }
        document.getElementById('adminLoginForm').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('adminEmail').value; const password = document.getElementById('adminPassword').value; loader.style.display = 'flex'; loaderText.textContent = 'Logging in...'; loginScreen.style.display = 'none'; auth.signInWithEmailAndPassword(email, password).catch(err => { alert('Login failed: ' + err.message); showLoginScreen(); }); });
        document.getElementById('adminLogoutBtn').addEventListener('click', () => auth.signOut());
        function initializeApp() { setupNavigation(); const initialPage = document.querySelector('.nav-link.active').dataset.page; showPage(initialPage); document.querySelectorAll('.modal .close-btn').forEach(btn => { btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none'); }); }
        function toggleSidebar() { sidebar.classList.toggle('open'); sidebarOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none'; }
        function setupNavigation() { menuToggle.onclick = toggleSidebar; sidebarOverlay.onclick = toggleSidebar; adminNav.onclick = (e) => { e.preventDefault(); const link = e.target.closest('.nav-link'); if (!link || link.classList.contains('active')) return; const pageId = link.dataset.page; showPage(pageId); adminNav.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); link.classList.add('active'); if (window.innerWidth <= 768) toggleSidebar(); }; }
        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); const page = document.getElementById(pageId); page.classList.add('active'); pageTitle.textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1).replace(/([A-Z])/g, ' $1').trim(); const contentLoaders = { dashboard: loadDashboardPage, games: loadGamesPage, tournaments: loadTournamentsPage, promoBanners: loadPromoBannersPage, users: loadUsersPage, deposits: loadDepositsPage, withdrawals: loadWithdrawalsPage, settings: loadSettingsPage, appContent: loadAppContentPage }; if (contentLoaders[pageId]) contentLoaders[pageId](); }
        async function loadDashboardPage() { const page = document.getElementById('dashboard'); page.innerHTML = `<div class="dashboard-grid"><div class="stat-card users"><div class="stat-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div><div class="stat-card-info"><h3>Total Users</h3><p id="totalUsersStat" class="stat-value">...</p></div></div><div class="stat-card tournaments"><div class="stat-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.58 16.09l-1.09-7.66C20.21 6.46 18.52 5 16.53 5H7.47C5.48 5 3.79 6.46 3.51 8.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19h0c.68 0 1.32-.27 1.76-.75L9 15h6l2.29 3.25c.44.48 1.08.75 1.76.75h0c1.55 0 2.74-1.37 2.53-2.91zM11 11H9v2H7v-2H5v-2h2V7h2v2h2v2zm7-2h-4v2h4v-2z"></path></svg></div><div class="stat-card-info"><h3>Active Tournaments</h3><p id="activeTournamentsStat" class="stat-value">...</p></div></div><div class="stat-card deposits"><div class="stat-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></div><div class="stat-card-info"><h3>Pending Deposits</h3><p id="pendingDepositsStat" class="stat-value">...</p></div></div><div class="stat-card withdrawals"><div class="stat-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16h4v-6h6v6h4l-7-7-7 7zM5 20v-2h14v2H5z"/></svg></div><div class="stat-card-info"><h3>Pending Withdrawals</h3><p id="pendingWithdrawalsStat" class="stat-value">...</p></div></div></div>`; const [usersSnap, tournamentsSnap, depositsSnap, withdrawalsSnap] = await Promise.all([db.collection('users').get(), db.collection('tournaments').where('status', 'in', ['Upcoming', 'Live']).get(), db.collection('depositRequests').where('status', '==', 'Pending').get(), db.collection('withdrawalRequests').where('status', '==', 'Pending').get()]); document.getElementById('totalUsersStat').textContent = usersSnap.size; document.getElementById('activeTournamentsStat').textContent = tournamentsSnap.size; document.getElementById('pendingDepositsStat').textContent = depositsSnap.size; document.getElementById('pendingWithdrawalsStat').textContent = withdrawalsSnap.size; }
        function loadGamesPage() { const page = document.getElementById('games'); page.innerHTML = `<div class="page-header"><h2>Manage Games</h2><button class="btn btn-primary" id="addGameBtn">Add New Game</button></div><div id="gamesListContainer" class="content-card-grid"><div class="loading-spinner" style="margin: 40px auto;"></div></div>`; document.getElementById('addGameBtn').onclick = () => openGameModal(null); document.getElementById('gameForm').onsubmit = saveGame; db.collection('games').orderBy('name').onSnapshot(snapshot => { allGamesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); const container = document.getElementById('gamesListContainer'); if (!container) return; if (snapshot.empty) { container.innerHTML = '<p>No games found. Click "Add New Game" to start.</p>'; return; } let html = ''; allGamesCache.forEach(game => { html += `<div class="content-card"><img src="${game.img}" class="card-image" alt="${game.name} cover" onerror="this.style.display='none'"><div class="card-content"><h4>${game.name}</h4></div><div class="card-footer"><div class="action-btns"><button class="btn" onclick="openGameModal('${game.id}')">Edit</button><button class="btn btn-danger" onclick="deleteGame('${game.id}', '${game.name}')">Delete</button></div></div></div>`; }); container.innerHTML = html; }, error => console.error("Error loading games: ", error)); }
        function loadTournamentsPage() { const page = document.getElementById('tournaments'); page.innerHTML = `<div class="page-header"><h2>Manage Tournaments</h2><button class="btn btn-primary" id="addTournamentBtn">Create New</button></div><div class="filter-controls" id="tournamentFilterControls"><button class="btn filter-btn active" data-status="All">All</button><button class="btn filter-btn" data-status="Upcoming">Upcoming</button><button class="btn filter-btn" data-status="Live">Live</button><button class="btn filter-btn" data-status="Complete">Complete</button></div><div id="tournamentsListContainer"><div class="loading-spinner" style="margin: 40px auto;"></div></div>`; document.getElementById('addTournamentBtn').onclick = () => openTournamentModal(null); document.getElementById('tournamentForm').onsubmit = saveTournament; document.getElementById('tournamentFilterControls').addEventListener('click', (e) => { const button = e.target.closest('.filter-btn'); if (!button) return; document.querySelectorAll('#tournamentFilterControls .filter-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); const status = button.dataset.status; renderTournaments(status); }); db.collection('tournaments').orderBy('dateTime', 'desc').onSnapshot(snapshot => { allTournamentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); const activeFilter = document.querySelector('#tournamentFilterControls .filter-btn.active')?.dataset.status || 'All'; renderTournaments(activeFilter); }, error => { console.error("Error loading tournaments: ", error); const container = document.getElementById('tournamentsListContainer'); if (container) container.innerHTML = '<p>Error loading tournaments.</p>'; }); }
        function renderTournaments(statusFilter = 'All') { const container = document.getElementById('tournamentsListContainer'); if (!container) return; const tournamentsToRender = (statusFilter === 'All') ? allTournamentsCache : allTournamentsCache.filter(t => t.status === statusFilter); if (tournamentsToRender.length === 0) { container.innerHTML = `<p>No ${statusFilter !== 'All' ? statusFilter.toLowerCase() : ''} tournaments found.</p>`; return; } let html = '<div class="admin-tournament-grid">'; tournamentsToRender.forEach(t => { const date = t.dateTime ? new Date(t.dateTime.toDate()).toLocaleString('en-IN', {day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true}) : 'N/A'; const registeredCount = t.registeredPlayers ? t.registeredPlayers.length : 0; html += `<div class="admin-tournament-card"><div class="card-header"><h4>${t.name}</h4><span class="status-badge status-${(t.status || '').toLowerCase()}">${t.status}</span></div><div class="card-body"><p><span class="label">Game</span><span class="value">${t.gameType}</span></p><p><span class="label">Date & Time</span><span class="value">${date}</span></p><p><span class="label">Registered</span><span class="value">${registeredCount} / ${t.maxPlayers}</span></p><p><span class="label">Entry Fee</span><span class="value">₹${t.entryFee}</span></p></div><div class="card-footer"><div class="action-btns"><button class="btn btn-secondary" onclick="openManageTournamentModal('${t.id}')">Manage</button><button class="btn" onclick="openTournamentModal('${t.id}')">Edit</button><button class="btn btn-danger" onclick="deleteTournament('${t.id}', '${t.name}')">Delete</button></div></div></div>`; }); container.innerHTML = html + '</div>'; }
        function loadPromoBannersPage() { const page = document.getElementById('promoBanners'); page.innerHTML = `<div class="page-header"><h2>Manage Promo Banners</h2><button class="btn btn-primary" id="addPromoBannerBtn">Add New Banner</button></div><div id="promoBannersListContainer" class="content-card-grid"><div class="loading-spinner" style="margin: 40px auto;"></div></div>`; document.getElementById('addPromoBannerBtn').onclick = () => openPromoBannerModal(null); document.getElementById('promoBannerForm').onsubmit = savePromoBanner; document.getElementById('promoBannerFileUpload').onchange = handleBannerImageUpload; db.collection('promoBanners').orderBy('createdAt', 'desc').onSnapshot(snapshot => { allPromoBannersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); const container = document.getElementById('promoBannersListContainer'); if (!container) return; if (snapshot.empty) { container.innerHTML = '<p>No promotional banners found.</p>'; return; } let html = ''; allPromoBannersCache.forEach(banner => { html += `<div class="content-card"><a href="${banner.imageUrl}" target="_blank" class="card-image-link"><img src="${banner.imageUrl}" class="card-image" alt="Promo Banner Preview"></a><div class="card-content"><p class="label">Target URL</p><p class="value">${banner.targetUrl || 'No link'}</p></div><div class="card-footer"><div class="action-btns"><button class="btn" onclick="openPromoBannerModal('${banner.id}')">Edit</button><button class="btn btn-danger" onclick="deletePromoBanner('${banner.id}', '${banner.imageUrl}')">Delete</button></div></div></div>`; }); container.innerHTML = html; }); }
        
        function loadAppContentPage() {
            const page = document.getElementById('appContent');
            page.innerHTML = `
                <div class="page-header">
                    <h2>Manage App Content</h2>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-color-muted);">Edit the content for various informational pages in the user app, like Privacy Policy, T&C, etc.</p>
                <div id="appContentFormsContainer" class="content-card-grid">
                    <div class="loading-spinner" style="margin: 40px auto;"></div>
                </div>
            `;

            const container = document.getElementById('appContentFormsContainer');
            const policies = {
                privacyPolicy: 'Privacy Policy',
                termsAndConditions: 'Terms & Conditions',
                refundPolicy: 'Refund & Cancellation',
                fairPlayPolicy: 'Fair Play Policy',
                supportInfo: 'Help & Support Info'
            };

            db.collection('appSettings').doc('policies').get().then(doc => {
                const data = doc.exists ? doc.data() : {};
                let html = '';
                for (const key in policies) {
                    const title = policies[key];
                    const content = data[key] || '';
                    html += `
                        <div class="content-card" style="gap:0;">
                            <div class="card-content">
                                <form class="policy-form" data-policy-key="${key}" onsubmit="savePolicyContent(event)">
                                    <h4>${title}</h4>
                                    <div class="form-group" style="margin-top:15px;">
                                        <textarea id="${key}Textarea" style="min-height: 200px;" placeholder="Enter content for ${title}">${content}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">Save ${title}</button>
                                </form>
                            </div>
                        </div>`;
                }
                container.innerHTML = html;
            }).catch(error => {
                container.innerHTML = `<p style="color:var(--danger-color);">Error loading content: ${error.message}</p>`;
                console.error("Error fetching policy content:", error);
            });
        }

        async function savePolicyContent(event) {
            event.preventDefault();
            const form = event.target;
            const policyKey = form.dataset.policyKey;
            const content = form.querySelector('textarea').value;
            const button = form.querySelector('button');
            
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                await db.collection('appSettings').doc('policies').set({
                    [policyKey]: content
                }, { merge: true });
                showNotification(`${form.querySelector('h4').textContent} saved successfully!`, 'success');
            } catch (error) {
                showNotification(`Error saving content: ${error.message}`, 'error');
                console.error("Error saving policy:", error);
            } finally {
                button.disabled = false;
                button.textContent = `Save ${form.querySelector('h4').textContent}`;
            }
        }
        
        function loadUsersPage() {
            const page = document.getElementById('users');
            page.innerHTML = `
                <div class="page-header">
                    <h2>User Management</h2>
                    <div class="search-container">
                        <input type="search" id="userSearchInput" placeholder="Search by name, email, or IGN...">
                    </div>
                </div>
                <div id="usersListContainer" class="request-card-grid">
                    <div class="loading-spinner" style="margin: 40px auto;"></div>
                </div>`;
            
            document.getElementById('walletAdjustmentForm').onsubmit = handleWalletAdjustment;
            
            document.getElementById('userSearchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredUsers = allUsersCache.filter(u => {
                    const username = (u.username || u.displayName || '').toLowerCase();
                    const email = (u.email || '').toLowerCase();
                    const ign = (u.ign || '').toLowerCase();
                    return username.includes(searchTerm) || email.includes(searchTerm) || ign.includes(searchTerm);
                });
                renderUsers(filteredUsers);
            });

            db.collection('users').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentSearchTerm = document.getElementById('userSearchInput')?.value.toLowerCase().trim() || '';
                if(currentSearchTerm){
                    const filteredUsers = allUsersCache.filter(u => {
                       const username = (u.username || u.displayName || '').toLowerCase();
                       const email = (u.email || '').toLowerCase();
                       const ign = (u.ign || '').toLowerCase();
                       return username.includes(currentSearchTerm) || email.includes(currentSearchTerm) || ign.includes(currentSearchTerm);
                    });
                    renderUsers(filteredUsers);
                } else {
                    renderUsers(allUsersCache);
                }
            });
        }
        
        function renderUsers(usersToRender) {
            const container = document.getElementById('usersListContainer');
            if (!container) return;
            if (usersToRender.length === 0) {
                container.innerHTML = '<p>No users found matching your criteria.</p>';
                return;
            }
            let html = '';
            usersToRender.forEach(u => {
                const username = u.username || u.displayName || 'N/A';
                const avatarLetter = username.charAt(0).toUpperCase();
                const isBanned = u.status === 'banned';
                html += `
                    <div class="admin-user-card ${isBanned ? 'banned' : ''}">
                        <div class="admin-user-card-header">
                            <div class="avatar">${avatarLetter}</div>
                            <div class="user-info">
                                <h5>${username}</h5>
                                <span class="user-email">${u.email}</span>
                            </div>
                        </div>
                        <div class="admin-user-card-body">
                            <div class="detail-item"><span class="label">IGN:</span><span class="value">${u.ign || 'Not Set'}</span></div>
                            <div class="detail-item"><span class="label">FF ID:</span><span class="value">${u.ffId || 'Not Set'}</span></div>
                            <div class="detail-item"><span class="label">Status:</span><span class="value">${isBanned ? 'Banned' : 'Active'}</span></div>
                            <div class="detail-item"><span class="label">Wallet:</span><span class="value" style="color:var(--success-color); font-weight:700;">₹${(u.walletBalance || 0).toFixed(2)}</span></div>
                        </div>
                        <div class="admin-user-card-footer">
                            <button class="btn ${isBanned ? 'btn-success' : 'btn-warning'}" onclick="toggleUserBan('${u.id}', ${isBanned})">${isBanned ? 'Unban' : 'Ban'}</button>
                            <button class="btn btn-secondary" onclick="openWalletModal('${u.id}')">Adjust Wallet</button>
                            <button class="btn btn-danger" onclick="deleteUser('${u.id}', '${username}')">Delete</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function loadDepositsPage() { const page = document.getElementById('deposits'); page.innerHTML = `<div class="page-header"><h2>Deposit Requests</h2></div><div class="request-card-grid" id="depositsListContainer"><div class="loading-spinner" style="margin: 40px auto;"></div></div>`; db.collection('depositRequests').orderBy('requestedAt', 'desc').onSnapshot(snapshot => { const container = document.getElementById('depositsListContainer'); if (!container) return; if (snapshot.empty) { container.innerHTML = '<p>No deposit requests found.</p>'; return; } let html = ''; snapshot.forEach(doc => { const req = { id: doc.id, ...doc.data() }; const date = req.requestedAt.toDate().toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); const isPending = req.status === 'Pending'; html += `<div class="request-card status-${req.status.toLowerCase()}"><div class="request-card-header"><div class="request-card-user"><h5>${req.displayName || 'N/A'}</h5><span class="email">${req.userEmail}</span></div><div class="request-card-amount deposit">+ ₹${req.amount.toFixed(2)}</div></div><div class="request-card-body"><div class="detail-item"><span class="label">UTR/Txn ID:</span> <span class="value">${req.transactionId}</span></div><div class="detail-item"><span class="label">Date:</span> <span class="value">${date}</span></div></div><div class="request-card-footer">${isPending ? `<button class="btn btn-success" onclick="processDeposit('${req.id}', 'Approved')">Approve</button><button class="btn btn-danger" onclick="processDeposit('${req.id}', 'Rejected')">Reject</button>` : `<p>Status: ${req.status}</p>`}</div></div>`; }); container.innerHTML = html; }); }
        async function loadWithdrawalsPage() { const page = document.getElementById('withdrawals'); page.innerHTML = `<div class="page-header"><h2>Withdrawal Requests</h2></div><div class="request-card-grid" id="withdrawalsListContainer"><div class="loading-spinner" style="margin: 40px auto;"></div></div>`; db.collection('withdrawalRequests').orderBy('requestedAt', 'desc').onSnapshot(async (snapshot) => { const container = document.getElementById('withdrawalsListContainer'); if (!container) return; if (snapshot.empty) { container.innerHTML = '<p>No withdrawal requests found.</p>'; return; } const userIds = [...new Set(snapshot.docs.map(doc => doc.data().userId))]; const userBalances = {}; if (userIds.length > 0) { const usersSnapshot = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', userIds).get(); usersSnapshot.forEach(userDoc => { userBalances[userDoc.id] = userDoc.data().walletBalance || 0; }); } let html = ''; snapshot.forEach(doc => { const req = { id: doc.id, ...doc.data() }; const date = req.requestedAt.toDate().toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }); const isPending = req.status === 'Pending'; const userBalance = userBalances[req.userId] !== undefined ? userBalances[req.userId] : 'N/A'; html += `<div class="request-card status-${req.status.toLowerCase()}"><div class="request-card-header"><div class="request-card-user"><h5>${req.displayName || 'N/A'}</h5><span class="email">${req.userEmail}</span></div><div class="request-card-amount withdrawal">- ₹${req.amount.toFixed(2)}</div></div><div class="request-card-body"><div class="detail-item"><span class="label">Method:</span> <span class="value">${req.method}</span></div><div class="detail-item"><span class="label">Current Balance:</span> <span class="value">₹${typeof userBalance === 'number' ? userBalance.toFixed(2) : userBalance}</span></div><div class="detail-item"><span class="label">Date:</span> <span class="value">${date}</span></div></div><div class="request-card-footer">${isPending ? `<button class="btn btn-success" onclick="processWithdrawal('${req.id}', 'Completed')">Mark Completed</button><button class="btn btn-danger" onclick="processWithdrawal('${req.id}', 'Rejected')">Reject</button>` : `<p>Status: ${req.status}</p>`}</div></div>`; }); container.innerHTML = html; }); }
        function loadSettingsPage() { const page = document.getElementById('settings'); page.innerHTML = `<div class="page-header"><h2>App Settings</h2></div><div class="stat-card" style="margin-bottom: 20px; flex-wrap:wrap;"><h3>Announcement</h3><form id="announcementForm" style="width:100%"><div class="form-group full-width"><label for="announcementText">Scrolling Text in App</label><textarea id="announcementText" required></textarea></div><button type="submit" class="btn btn-primary">Save Announcement</button></form></div><div class="stat-card" style="flex-wrap:wrap;"><h3>Payment Settings</h3><form id="paymentSettingsForm" style="width:100%"><div class="form-group full-width"><label for="adminUpiId">Admin UPI ID</label><input type="text" id="adminUpiId" required></div><div class="form-group full-width"><label for="adminQrCodeUrl">Admin QR Code URL</label><input type="url" id="adminQrCodeUrl" placeholder="Upload new file to get URL"><label for="qrFileUpload" style="margin-top: 10px; cursor:pointer;" class="btn btn-secondary">Upload New QR Code</label><input type="file" id="qrFileUpload" accept="image/*" style="display:none;"><span id="uploadProgress" style="margin-left: 10px; font-size: 0.9em;"></span></div><button type="submit" class="btn btn-primary">Save Payment Settings</button></form></div>`; document.getElementById('announcementForm').onsubmit = saveAnnouncement; document.getElementById('paymentSettingsForm').onsubmit = savePaymentSettings; document.getElementById('qrFileUpload').onchange = handleQrUpload; db.collection('appSettings').doc('announcements').get().then(doc => { if (doc.exists) document.getElementById('announcementText').value = doc.data().text || ''; }); db.collection('appSettings').doc('paymentInfo').get().then(doc => { if (doc.exists) { document.getElementById('adminUpiId').value = doc.data().adminUpiId || ''; document.getElementById('adminQrCodeUrl').value = doc.data().adminQrCodeUrl || ''; } }); }
        function openGameModal(gameId) { const form = document.getElementById('gameForm'); form.reset(); const modal = document.getElementById('gameModal'); const title = document.getElementById('gameModalTitle'); if (gameId) { title.textContent = "Edit Game"; const game = allGamesCache.find(g => g.id === gameId); if (!game) return; document.getElementById('gameId').value = game.id; document.getElementById('gameName').value = game.name; document.getElementById('gameImgUrl').value = game.img; } else { title.textContent = "Add New Game"; document.getElementById('gameId').value = ''; } modal.style.display = 'flex'; }
        async function saveGame(e) { e.preventDefault(); const gameId = document.getElementById('gameId').value; const gameData = { name: document.getElementById('gameName').value.trim(), img: document.getElementById('gameImgUrl').value.trim(), }; if (!gameData.name || !gameData.img) { showNotification('Both name and image URL are required.', 'error'); return; } try { if (gameId) { await db.collection('games').doc(gameId).update(gameData); showNotification('Game updated!', 'success'); } else { await db.collection('games').add(gameData); showNotification('Game created!', 'success'); } document.getElementById('gameModal').style.display = 'none'; } catch (error) { showNotification('Error: ' + error.message, 'error'); } }
        function deleteGame(id, name) { if (confirm(`Are you sure you want to delete "${name}"? This will NOT delete tournaments associated with it.`)) { db.collection('games').doc(id).delete().then(() => showNotification('Game deleted.', 'success')).catch(err => showNotification('Error: ' + err.message, 'error')); } }
        async function populateGameDropdown() { const select = document.getElementById('tGameType'); select.innerHTML = '<option value="">Loading Games...</option>'; try { const snapshot = await db.collection('games').orderBy('name').get(); allGamesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); select.innerHTML = '<option value="">-- Select a Game --</option>'; allGamesCache.forEach(game => { select.innerHTML += `<option value="${game.name}">${game.name}</option>`; }); } catch (error) { select.innerHTML = '<option value="">Could not load games</option>'; } }
        async function openTournamentModal(tournamentId) { const form = document.getElementById('tournamentForm'); form.reset(); const modal = document.getElementById('tournamentModal'); const title = document.getElementById('tournamentModalTitle'); await populateGameDropdown(); if (tournamentId) { title.textContent = "Edit Tournament"; const t = allTournamentsCache.find(t => t.id === tournamentId); if (!t) return; document.getElementById('tournamentId').value = t.id; document.getElementById('tName').value = t.name; document.getElementById('tGameType').value = t.gameType; const dt = t.dateTime ? t.dateTime.toDate() : new Date(); document.getElementById('tDateTime').value = new Date(dt.getTime() - (dt.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); document.getElementById('tMode').value = t.mode; document.getElementById('tMap').value = t.map; document.getElementById('tStatus').value = t.status; document.getElementById('tEntryFee').value = t.entryFee; document.getElementById('tPrizePool').value = t.prizePool; document.getElementById('tPrizePerKill').value = t.prizePerKill; document.getElementById('tMaxPlayers').value = t.maxPlayers; document.getElementById('tRules').value = t.rules || ''; } else { title.textContent = "Create Tournament"; document.getElementById('tournamentId').value = ''; } modal.style.display = 'flex'; }
        async function saveTournament(e) { e.preventDefault(); const tournamentId = document.getElementById('tournamentId').value; const tournamentData = { name: document.getElementById('tName').value, gameType: document.getElementById('tGameType').value, dateTime: new Date(document.getElementById('tDateTime').value), mode: document.getElementById('tMode').value, map: document.getElementById('tMap').value, status: document.getElementById('tStatus').value, entryFee: Number(document.getElementById('tEntryFee').value), prizePool: Number(document.getElementById('tPrizePool').value), prizePerKill: Number(document.getElementById('tPrizePerKill').value), maxPlayers: Number(document.getElementById('tMaxPlayers').value), rules: document.getElementById('tRules').value, }; if (!tournamentData.gameType) { showNotification('Please select a game type.', 'error'); return; } try { if (tournamentId) { await db.collection('tournaments').doc(tournamentId).update(tournamentData); showNotification('Tournament updated!', 'success'); } else { await db.collection('tournaments').add(tournamentData); showNotification('Tournament created!', 'success'); } document.getElementById('tournamentModal').style.display = 'none'; } catch (error) { showNotification('Error: ' + error.message, 'error'); } }
        function deleteTournament(id, name) { if (confirm(`Are you sure you want to delete the tournament "${name}"? This cannot be undone.`)) { db.collection('tournaments').doc(id).delete().then(() => { showNotification('Tournament deleted.', 'success'); }).catch(err => showNotification('Error deleting: ' + err.message, 'error')); } }
        function openPromoBannerModal(bannerId) { const form = document.getElementById('promoBannerForm'); form.reset(); const modal = document.getElementById('promoBannerModal'); const title = document.getElementById('promoBannerModalTitle'); document.getElementById('promoBannerUploadProgress').textContent = ''; if (bannerId) { title.textContent = "Edit Banner"; const banner = allPromoBannersCache.find(b => b.id === bannerId); if (!banner) return; document.getElementById('promoBannerId').value = banner.id; document.getElementById('promoBannerImageUrl').value = banner.imageUrl; document.getElementById('promoBannerTargetUrl').value = banner.targetUrl || ''; document.getElementById('promoBannerOldImageUrl').value = banner.imageUrl; } else { title.textContent = "Add New Banner"; } modal.style.display = 'flex'; }
        async function savePromoBanner(e) { e.preventDefault(); const id = document.getElementById('promoBannerId').value; const imageUrl = document.getElementById('promoBannerImageUrl').value.trim(); const targetUrl = document.getElementById('promoBannerTargetUrl').value.trim(); if (!imageUrl) { showNotification('Banner Image URL is required.', 'error'); return; } const data = { imageUrl, targetUrl, createdAt: firebase.firestore.FieldValue.serverTimestamp() }; try { if (id) { delete data.createdAt; await db.collection('promoBanners').doc(id).update(data); showNotification('Banner updated!', 'success'); } else { await db.collection('promoBanners').add(data); showNotification('Banner added!', 'success'); } document.getElementById('promoBannerModal').style.display = 'none'; } catch (error) { showNotification('Error: ' + error.message, 'error'); } }
        function deletePromoBanner(id, imageUrl) { if (!confirm("Are you sure you want to delete this banner? This will also delete the image from storage.")) return; db.collection('promoBanners').doc(id).delete().then(() => { if (imageUrl.includes('firebasestorage')) { storage.refFromURL(imageUrl).delete().catch(err => console.error("Error deleting image from storage:", err)); } showNotification('Banner deleted.', 'success'); }).catch(err => showNotification('Error deleting banner: ' + err.message, 'error')); }
        function handleBannerImageUpload(e) { const file = e.target.files[0]; if (!file) return; const storageRef = storage.ref(`promo_banners/${Date.now()}_${file.name}`); const uploadTask = storageRef.put(file); const progressSpan = document.getElementById('promoBannerUploadProgress'); uploadTask.on('state_changed', (snapshot) => { const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; progressSpan.textContent = `Uploading: ${progress.toFixed(0)}%`; }, (error) => { showNotification('Upload error: ' + error.message, 'error'); progressSpan.textContent = 'Upload failed.'; }, () => { uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => { document.getElementById('promoBannerImageUrl').value = downloadURL; showNotification('Image uploaded! Click Save Banner.', 'success'); progressSpan.textContent = 'Upload complete.'; }); }); }
        
        async function openManageTournamentModal(tournamentId) { const modal = document.getElementById('manageTournamentModal'); modal.style.display = 'flex'; modal.innerHTML = '<div class="loading-spinner"></div>'; const t = await db.collection('tournaments').doc(tournamentId).get(); if (!t.exists) { modal.innerHTML = '<p>Tournament not found.</p>'; return; } const data = t.data(); let playersHtml = '<h4>No players registered.</h4>'; if (data.registeredPlayers && data.registeredPlayers.length > 0) { playersHtml = '<div class="player-list">'; playersHtml += data.registeredPlayers.map(p => `<div class="player-card"><div class="player-card-header"><h5>${p.displayName || 'N/A'}</h5><span class="player-ign">${p.ign || 'No IGN'}</span></div><div class="player-details-grid"><div class="detail-item"><span class="label">FF ID:</span><span class="value">${p.ffId || 'N/A'}</span></div><div class="detail-item"><span class="label">Team:</span><span class="value">${p.teamName || 'Solo'}</span></div></div><div class="player-actions"><div class="result-group"><label>Kills:</label><input type="number" data-field="kills" value="${p.kills || 0}"></div><div class="result-group"><label>Prize (₹):</label><input type="number" data-field="prize" value="${p.prize || 0}"></div><button class="btn btn-secondary" onclick="savePlayerResult(event, '${t.id}', '${p.userId}')">Save & Pay</button></div></div>`).join(''); playersHtml += '</div>'; } modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="manageTournamentTitle">Manage: ${data.name}</h2><button class="close-btn" onclick="this.closest('.modal').style.display='none'">×</button></div><div class="form-group"><label>Room ID & Password</label><textarea id="roomDetailsTextarea">${data.roomDetails || ''}</textarea><button class="btn btn-primary" style="margin-top:10px;" onclick="saveRoomDetails('${t.id}')">Save Room Details</button></div><h3>Registered Players (${data.registeredPlayers ? data.registeredPlayers.length : 0})</h3>${playersHtml}</div>`; }
        async function saveRoomDetails(tournamentId) { const details = document.getElementById('roomDetailsTextarea').value; try { await db.collection('tournaments').doc(tournamentId).update({ roomDetails: details }); showNotification('Room details saved!', 'success'); } catch (error) { showNotification('Error: ' + error.message, 'error'); } }
        async function savePlayerResult(event, tournamentId, userId) { const saveBtn = event.target; saveBtn.disabled = true; saveBtn.textContent = "Saving..."; const playerCard = saveBtn.closest('.player-card'); const kills = Number(playerCard.querySelector('input[data-field="kills"]').value); const prize = Number(playerCard.querySelector('input[data-field="prize"]').value); const tournamentRef = db.collection('tournaments').doc(tournamentId); const userRef = db.collection('users').doc(userId); let usernameForNotification = 'player'; try { await db.runTransaction(async (transaction) => { const tDoc = await transaction.get(tournamentRef); const userDoc = await transaction.get(userRef); if (!tDoc.exists) { throw new Error("Tournament not found."); } if (!userDoc.exists) { throw new Error("User not found."); } const tournamentData = tDoc.data(); const userData = userDoc.data(); usernameForNotification = userData.username || userId; const players = tournamentData.registeredPlayers; const playerIndex = players.findIndex(p => p.userId === userId); if (playerIndex === -1) { throw new Error("Player not found in tournament."); } players[playerIndex].kills = kills; players[playerIndex].prize = prize; players[playerIndex].resultStatus = 'Verified'; transaction.update(tournamentRef, { registeredPlayers: players }); if (prize > 0) { const currentBalance = userData.walletBalance || 0; const newBalance = currentBalance + prize; transaction.update(userRef, { walletBalance: newBalance }); const transRef = db.collection('transactions').doc(); transaction.set(transRef, { userId: userId, amount: prize, type: 'credit', description: `Prize for: ${tournamentData.name}`, tournamentId: tournamentId, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); } }); showNotification(`Result Saved & Wallet Updated for ${usernameForNotification}!`, 'success'); } catch (error) { showNotification(`Error: ${error.message}`, 'error'); console.error("Transaction failed: ", error); } finally { saveBtn.disabled = false; saveBtn.textContent = "Save & Pay"; } }
        function openWalletModal(userId) { const user = allUsersCache.find(u => u.id === userId); if (!user) return; const modal = document.getElementById('userWalletModal'); const form = document.getElementById('walletAdjustmentForm'); form.reset(); form.querySelector('#walletUserId').value = userId; modal.querySelector('#userWalletTitle').textContent = `Adjust Wallet for ${user.username}`; modal.querySelector('#currentUserBalance').textContent = `₹${(user.walletBalance || 0).toFixed(2)}`; modal.style.display = 'flex'; }
        async function handleWalletAdjustment(e) { e.preventDefault(); const userId = document.getElementById('walletUserId').value; const amount = parseFloat(document.getElementById('adjustmentAmount').value); const type = document.getElementById('adjustmentType').value; const reason = document.getElementById('adjustmentReason').value; if (isNaN(amount) || amount <= 0) { showNotification('Invalid amount.', 'error'); return; } const finalAmount = type === 'credit' ? amount : -amount; const userRef = db.collection('users').doc(userId); try { await db.runTransaction(async (transaction) => { const userDoc = await transaction.get(userRef); if (!userDoc.exists) throw "User not found."; const currentBalance = userDoc.data().walletBalance || 0; const newBalance = currentBalance + finalAmount; if (newBalance < 0) throw "Debit amount exceeds user balance."; transaction.update(userRef, { walletBalance: newBalance }); const transRef = db.collection('transactions').doc(); transaction.set(transRef, { userId: userId, amount: Math.abs(finalAmount), type: type, description: `Admin Adjustment: ${reason}`, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); }); showNotification('Wallet updated!', 'success'); document.getElementById('userWalletModal').style.display = 'none'; } catch (error) { showNotification('Error: ' + error, 'error'); } }
        
        async function processDeposit(reqId, newStatus) {
            const reqRef = db.collection('depositRequests').doc(reqId);
            try {
                const reqDoc = await reqRef.get();
                if (!reqDoc.exists) {
                    throw new Error('Request not found!');
                }
                const reqData = reqDoc.data();
                if (reqData.status !== 'Pending') {
                    throw new Error('This request has already been processed.');
                }
                
                const transactionsQuery = await db.collection('transactions')
                    .where('depositRequestId', '==', reqId)
                    .limit(1)
                    .get();

                if (newStatus === 'Approved') {
                    const userRef = db.collection('users').doc(reqData.userId);
                    
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw new Error("User not found to credit balance.");

                        const currentBalance = userDoc.data().walletBalance || 0;
                        const newBalance = currentBalance + reqData.amount;
                        transaction.update(userRef, { walletBalance: newBalance });

                        transaction.update(reqRef, {
                            status: 'Approved',
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        if (!transactionsQuery.empty) {
                            const transactionToUpdateRef = transactionsQuery.docs[0].ref;
                            transaction.update(transactionToUpdateRef, {
                                status: 'Completed',
                                description: 'Deposit Approved'
                            });
                        } else {
                            const newTransactionRef = db.collection('transactions').doc();
                            transaction.set(newTransactionRef, {
                                userId: reqData.userId,
                                amount: reqData.amount,
                                type: 'credit',
                                description: 'Deposit Approved (Manual)',
                                status: 'Completed',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    });
                    showNotification('Deposit approved and wallet credited!', 'success');

                } else { // If 'Rejected'
                    await reqRef.update({
                        status: 'Rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    if (!transactionsQuery.empty) {
                        const transactionToUpdateRef = transactionsQuery.docs[0].ref;
                        await transactionToUpdateRef.update({
                            status: 'Rejected',
                            description: `Deposit Rejected (Ref: ${reqData.transactionId})`
                        });
                    }
                    showNotification('Deposit has been rejected.', 'info');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
                console.error("Error processing deposit:", error);
            }
        }
        
        async function processWithdrawal(reqId, newStatus) {
            const reqRef = db.collection('withdrawalRequests').doc(reqId);
            try {
                await db.runTransaction(async (transaction) => {
                    const reqDoc = await transaction.get(reqRef);
                    if (!reqDoc.exists) throw new Error("Request not found.");
                    
                    const reqData = reqDoc.data();
                    if (reqData.status !== 'Pending') throw new Error("Request has already been processed.");
                    
                    if (!reqData.transactionId) throw new Error("FATAL: Original transaction ID is missing from the request!");
                    const originalTransactionRef = db.collection('transactions').doc(reqData.transactionId);

                    if (newStatus === 'Completed') {
                        transaction.update(reqRef, { 
                            status: 'Completed',
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        transaction.update(originalTransactionRef, { 
                            status: 'Completed',
                            description: `Withdrawal to ${reqData.method}`
                        });

                    } else if (newStatus === 'Rejected') {
                        const userRef = db.collection('users').doc(reqData.userId);
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw new Error("User not found for refund.");

                        const currentBalance = userDoc.data().walletBalance || 0;
                        const newBalance = currentBalance + reqData.amount;
                        transaction.update(userRef, { walletBalance: newBalance });

                        transaction.update(reqRef, { 
                            status: 'Rejected',
                            rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        transaction.delete(originalTransactionRef);

                        const refundTransRef = db.collection('transactions').doc();
                        transaction.set(refundTransRef, {
                            userId: reqData.userId,
                            amount: reqData.amount,
                            type: 'credit',
                            status: 'Completed',
                            description: `Refund for rejected withdrawal`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });

                if (newStatus === 'Completed') {
                    showNotification('Withdrawal marked as completed!', 'success');
                } else {
                    showNotification('Withdrawal rejected. Funds returned to user wallet.', 'info');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
                console.error("Withdrawal processing failed: ", error);
            }
        }
        
        async function saveAnnouncement(e) { e.preventDefault(); const text = document.getElementById('announcementText').value; await db.collection('appSettings').doc('announcements').set({ text: text }); showNotification('Announcement saved!', 'success'); }
        async function savePaymentSettings(e) { e.preventDefault(); const upiId = document.getElementById('adminUpiId').value; const qrUrl = document.getElementById('adminQrCodeUrl').value; await db.collection('appSettings').doc('paymentInfo').set({ adminUpiId: upiId, adminQrCodeUrl: qrUrl }, { merge: true }); showNotification('Payment settings saved!', 'success'); }
        function handleQrUpload(e) { const file = e.target.files[0]; if (!file) return; const storageRef = storage.ref(`settings/payment_qr_code_${Date.now()}`); const uploadTask = storageRef.put(file); const progressSpan = document.getElementById('uploadProgress'); uploadTask.on('state_changed', (snapshot) => { const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; progressSpan.textContent = `Uploading: ${progress.toFixed(0)}%`; }, (error) => { showNotification('Upload error: ' + error.message, 'error'); progressSpan.textContent = 'Upload failed.'; }, () => { uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => { document.getElementById('adminQrCodeUrl').value = downloadURL; showNotification('QR Code uploaded! Press Save.', 'success'); progressSpan.textContent = 'Upload complete.'; }); }); }
        async function toggleUserBan(userId, isCurrentlyBanned) { const newStatus = isCurrentlyBanned ? 'active' : 'banned'; const actionText = isCurrentlyBanned ? 'Unban' : 'Ban'; if (confirm(`Are you sure you want to ${actionText} this user?`)) { try { await db.collection('users').doc(userId).update({ status: newStatus }); showNotification(`User has been ${actionText}ned.`, 'success'); } catch (error) { showNotification(`Error: ${error.message}`, 'error'); } } }
        async function deleteUser(userId, username) { if (confirm(`DANGER: Are you sure you want to PERMANENTLY DELETE user "${username}"? This cannot be undone.`)) { try { await db.collection('users').doc(userId).delete(); showNotification(`User "${username}" has been deleted.`, 'success'); } catch (error) { showNotification(`Error deleting user: ${error.message}`, 'error'); } } }
        let notificationTimeout; function showNotification(msg, type="success"){ clearTimeout(notificationTimeout); notificationDiv.textContent=msg; let bg; switch(type){ case "success":bg="var(--success-color)";break; case "error":bg="var(--danger-color)";break; case "info": default: bg="var(--info-color)"; } notificationDiv.style.backgroundColor=bg; notificationDiv.style.display="block"; notificationTimeout=setTimeout(()=>{notificationDiv.style.display="none";},4000); }
    </script>
</body>
</html>
